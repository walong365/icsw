{% load i18n coffeescript staticfiles %}

<nav class="navbar navbar-default navbar-fixed-top" role="navigation" id="icsw.menu_app" ng-controller="menu_base" ng-cloak ng-show="is_authenticated">
    <ul class="nav navbar-nav">
        <li>
            <a href="{% url 'main:index' %}"><span class="glyphicon glyphicon-home"></span></a>
        </li>
        <li ng-show="
        		check_perm('user.modify_tree') || check_perm('user.modify_domain_name_tree') ||
        		check_perm('user.modify_category_tree') || check_perm('config.modify_config') ||
        		check_perm('config.modify_network') || check_perm('device.change_network') || 
        		check_perm('device.change_connection') || check_perm('device.change_variables') || check_perm('device.change_config')
        		">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Base" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li ng-show="check_perm('user.modify_tree')"><a href="{% url 'mon:create_device' %}">{% trans "Create new device" %}</a></li>
                <li ng-show="check_perm('user.modify_tree')" class="divider"></li>
                <li ng-show="check_perm('user.modify_tree')"><a href="{% url 'device:tree' %}">{% trans "Device tree" %}</a></li>
                <li ng-show="check_perm('user.modify_domain_name_tree')"><a href="{% url 'network:domain_name_tree' %}">{% trans "Domain name tree" %}</a></li>
                <li ng-show="check_perm('user.modify_category_tree')"><a href="{% url 'base:category_tree' %}">{% trans "Category tree" %}</a></li>
                <li ng-show="check_perm('user.modify_category_tree') || check_perm('user.modify_domain_tree') || check_perm('user.modify_tree')" class="divider"></li>
                <li ng-show="check_perm('network.modify_network')"><a href="{% url 'network:show_networks' %}">{% trans "Networks" %}</a></li>
                <li ng-show="check_perm('config.modify_config')"><a href="{% url 'config:show_configs' %}">{% trans "Configurations" %}</a></li>
                <li ng-show="check_perm('network.modify_network') || check_perm('config.modify_config')" class="divider"></li>
                <li ng-show="check_perm('device.change_network')"><a href="{% url 'network:device_network' %}">{% trans "Device network" %}</a></li>
                <li ng-show="check_perm('device.change_connection')"><a href="{% url 'device:connections' %}">{% trans "Device connections" %}</a></li>
                <li ng-show="check_perm('device.change_variables')"><a href="{% url 'device:variables' %}">{% trans "Device variables" %}</a></li>
                <li ng-show="check_perm('device.change_config')"><a href="{% url 'device:show_configs' %}">{% trans "Device configurations" %}</a></li>
            </ul>
        </li>
        <li ng-show="
        		(CLUSTER_LICENSE.boot.enabled || CLUSTER_LICENSE.package.enabled) && (check_perm('device.change_boot') || check_perm('package.package_install') || 
        		check_perm('partition_fs.modify_partitions') || check_perm('kernel.modify_kernels') || check_perm('image.modify_images'))
        		">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Cluster" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li ng-show="SERVICE_TYPES.mother && CLUSTER_LICENSE.boot.enabled && check_perm('device.change_boot')"><a href="{% url 'boot:show_boot' %}">{% trans "Nodeboot" %}</a></li>
                <li ng-show="SERVICE_TYPES.package && CLUSTER_LICENSE.package.enabled && check_perm('package.package_install')"><a href="{% url 'pack:repo_overview' %}">{% trans "Package install" %}</a></li>
                {% if DJANGO_SERVICE_TYPES.mother or DJANGO_SERVICE_TYPES.package %}
                <li ng-show="CLUSTER_LICENSE.boot.enabled" class="divider"></li>
                {% endif %}
                <li ng-show="CLUSTER_LICENSE.boot.enabled && check_perm('image.modify_images')"><a href="{% url 'setup:image_overview' %}">{% trans "Image overview" %}</a></li>
                <li ng-show="CLUSTER_LICENSE.boot.enabled && check_perm('kernel.modify_kernels')"><a href="{% url 'setup:kernel_overview' %}">{% trans "Kernel overview" %}</a></li>
                <li ng-show="CLUSTER_LICENSE.boot.enabled && check_perm('partition_fs.modify_partitions')"><a href="{% url 'setup:partition_overview' %}">{% trans "Partition overview" %}</a></li>
            </ul>
        </li>
        <li ng-show="check_perm('group.group_admin')">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Users" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="{% url 'user:overview' %}">{% trans "Overview" %}</a></li>
            </ul>
        </li>
        <li ng-show="CLUSTER_LICENSE.monitor.enabled">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Monitoring" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li ng-show="check_perm('mon_check_command.setup_monitoring')"><a href="{% url 'mon:setup' %}">{% trans "Basic setup" %}</a></li>
                <li ng-show="check_perm('mon_check_command.setup_monitoring') && check_perm('device.change_monitoring')"><a href="{% url 'mon:device_config' %}">{% trans "Device settings" %}</a></li>
                <li ng-show="CLUSTER_LICENSE.monext.enabled && check_perm('mon_check_command.setup_monitoring')" class="divider"></li>
                <li ng-show="CLUSTER_LICENSE.monext.enabled && check_perm('mon_check_command.setup_monitoring')"><a href="{% url 'mon:setup_cluster' %}">{% trans "Cluster / Dependency setup" %}</a></li>
                <li ng-show="CLUSTER_LICENSE.monext.enabled && check_perm('mon_check_command.setup_monitoring')"><a href="{% url 'mon:setup_escalation' %}">{% trans "Escalation setup" %}</a></li>
                <li ng-show="check_perm('mon_check_command.setup_monitoring')" class="divider"></li>
                <li><a href="{% url 'mon:call_icinga' %}">{% trans "Icinga (replace)" %}</a></li>
                <li><a href="{% url 'mon:call_icinga' %}" target="_blank">{% trans "Icinga (new tab)" %}</a></li>
                <li ng-show="check_perm('mon_check_command.setup_monitoring')" class="divider"></li>
                <li ng-show="check_perm('mon_check_command.setup_monitoring')"><a href="{% url 'mon:build_info' %}">{% trans "Build Info" %}</a></li>
{% if DJANGO_SERVICE_TYPES.md_config %}                    
                    <li>
                        <a href="{% url 'mon:livestatus' %}">{% trans "Livestatus" %}</a>
                    </li>
                    <li ng-show="check_perm('mon_check_command.setup_monitoring')" class="text-left">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <input type="button" class="btn btn-success btn-xs" value="rebuild config (cached, RC)" title="fully cached (with routing cache)" ng-click="rebuild_config('ALWAYS')"/>
                            </li>
                            <li class="list-group-item">
                                <input type="button" class="btn btn-warning btn-xs" value="rebuild config (dynamic)" ng-click="rebuild_config('DYNAMIC')"/>
                            </li>
                            <li class="list-group-item">
                                <input type="button" class="btn btn-danger btn-xs" value="rebuild config (refresh)" ng-click="rebuild_config('REFRESH')"/>
                            </li>
                        </ul>
                    </li>
{% endif %}
                </ul>
            </li>
            <li ng-show="CLUSTER_LICENSE.rms.enabled">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "RMS" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="{% url 'rms:overview' %}">{% trans "RMS overview" %}</a></li>
                <li><a href="{% url 'lic:overview' %}" ng-show="0">{% trans "License overview" %}</a></li>
                <li><a href="{% url 'lic:license_liveview' %}">{% trans "License LiveView" %}</a></li>
            </ul>
        </li>
        {% for add_menu in settings.ADDITIONAL_MENU_FILES %}
            {% include add_menu %}
        {% endfor %}
        <li class="visible-md visible-lg">
            {% verbatim %}
            <div ng-show="num_gauges" ng-repeat="(key, obj) in cur_gauges" class="progress" style="width:200px; margin-top:10px;">
                <progressbar animate="true" value="obj.value" type="success"><span>{{ obj.value }} %</span></progressbar>
            </div>
            {% endverbatim %}
        </li>
        <li ng-if="num_gauges == 0" class="visible-lg visible-md">
            {% with "images/product/"|add:settings.INIT_PRODUCT_NAME|lower|add:"-flat-trans.png" as gfx_name %}
            <img height="42px" src="{% static gfx_name %}" ng-click="redirect_to_init()" title="{{ settings.INIT_PRODUCT_NAME }}" alt="{{ settings.INIT_PRODUCT_NAME }} logo">
            </img>
            {% endwith %}
        </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
        <li>
            <p class="navbar-text">
                <button type="button" class="btn btn-danger btn-xs" title="cluster server information" ng-click="redirect_to_info()">
                    <span class="glyphicon glyphicon-stats" style="font-size:12px;"></span>
                </button>
                &nbsp;
                <button ng-show="HANDBOOK_PDF_PRESENT" type="button" class="btn btn-primary btn-xs" title="show cluster handbook as PDF" ng-click="redirect_to_handbook()">
                    <span class="glyphicon glyphicon-print" style="font-size:12px;"></span>
                </button>
                &nbsp;
                {% verbatim %}
                <button ng-show="HANDBOOK_CHUNKS_PRESENT" type="button" class="btn btn-success btn-xs" title="show {{ HANDBOOK_PAGE }}" ng-click="show_handbook_page()">
                    <span class="glyphicon glyphicon-question-sign" style="font-size:12px;"></span>
                </button>
                {% endverbatim %}
                &nbsp;
                <button type="button" ng-show="NUM_BACKGROUND_JOBS" ng-class="get_background_job_class()" ng-click="redirect_to_bgj_info()" title="number of background jobs">{{ NUM_BACKGROUND_JOBS }}</button>
            </p>
        </li>
        <li>
            <p class="navbar-text visible-md visible-lg"">
                {% verbatim %}{{ cur_time }}{% endverbatim %}, 
                <span title="{{ user }}">user '{{ user.login }}'</span>{% ifnotequal user.login request.session.login_name %} (via alias {{ request.session.login_name }}){% endifnotequal %}
            </p>
        </li>
        <li>
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Session" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="{% url 'user:account_info' %}"><span class="glyphicon glyphicon-info-sign"></span>&nbsp;{% trans "Account Info" %}</a></li>
                <li ng-show="check_perm('backbone.user.admin')"><a href="{% url 'admin:index' %}"><span class="glyphicon glyphicon-wrench"></span>&nbsp;{% trans "Admin" %}</a></li>
                {% if user.is_superuser %}
                    <li><a href="{% url 'user:global_settings' %}"><span class="glyphicon glyphicon-pencil"></span>&nbsp;{% trans "Settings" %}</a></li>
                {% endif %}
                <li ng-show="check_perm('background_job.show_background')">
                    <a href="{% url 'user:background_job_info' %}"><span class="glyphicon glyphicon-list"></span>&nbsp;{% trans "Background Job Info" %}</a>
                </li>
                <li><a href="{% url 'session:logout' %}"><span class="glyphicon glyphicon-arrow-left"></span>&nbsp;{% trans "Logout" %}</a></li>
            </ul>
        </li>
        <li>
            &nbsp;
        </li>
    </ul>
</nav>

<script type="text/javascript">

{% inlinecoffeescript %}

root = exports ? this

menu_module = angular.module("icsw.menu_app", ["ngSanitize", "ui.bootstrap"])

menu_controller = menu_module.controller("menu_base", ["$scope", "$timeout", "$window",
    ($scope, $timeout, $window) ->
        $scope.is_authenticated = $window.IS_AUTHENTICATED
        $scope.CLUSTER_LICENSE = $window.CLUSTER_LICENSE
        $scope.GLOBAL_PERMISSIONS = $window.GLOBAL_PERMISSIONS
        $scope.OBJECT_PERMISSIONS = $window.OBJECT_PERMISSIONS
        $scope.NUM_BACKGROUND_JOBS = $window.NUM_BACKGROUND_JOBS
        $scope.SERVICE_TYPES = $window.SERVICE_TYPES
        $scope.HANDBOOK_PDF_PRESENT = {% if settings.HANDBOOK_PDF_PRESENT %}1{% else %}0{% endif %}
        {% if doc_page %}
        $scope.HANDBOOK_CHUNKS_PRESENT = {% if settings.HANDBOOK_CHUNKS_PRESENT %}1{% else %}0{% endif %}
        $scope.HANDBOOK_PAGE = "{{ doc_page }}"
        {% else %}
        $scope.HANDBOOK_CHUNKS_PRESENT = 0
        $scope.HANDBOOK_PAGE = "---"
        {% endif %}
        $scope.check_perm = (p_name) ->
            if p_name.split(".").length == 2
                p_name = "backbone.#{p_name}"
            if p_name of GLOBAL_PERMISSIONS
                return true
            else if p_name of OBJECT_PERMISSIONS
                return true
            else
                return false
        $scope.progress_iters = 0
        $scope.cur_gauges = {}
        $scope.num_gauges = 0
        $scope.get_progress_style = (obj) ->
            return {"width" : "#{obj.value}%"}
        $scope.show_time = () ->
            $scope.cur_time = moment().format("ddd, Do MMMM YYYY HH:mm:ss")
            $timeout($scope.show_time, 1000)
        $scope.update_progress_bar = () ->
            call_ajax
                url     : "{% url 'base:get_gauge_info' %}",
                hidden  : true,
                success : (xml) =>
                    cur_pb = []
                    if parse_xml_response(xml)
                        $(xml).find("gauge_info gauge_element").each (idx, cur_g) ->
                            cur_g = $(cur_g)
                            idx = cur_g.attr("idx")
                            if idx of $scope.cur_gauges
                                $scope.cur_gauges[idx].info = cur_g.text()
                                $scope.cur_gauges[idx].value = parseInt(cur_g.attr("value"))
                            else
                                $scope.cur_gauges[idx] = {info : cur_g.text(), value : parseInt(cur_g.attr("value"))}
                            cur_pb.push(idx)
                    del_pbs = (cur_idx for cur_idx of $scope.cur_gauges when cur_idx not in cur_pb)
                    for del_pb in del_pbs
                        delete $scope.cur_gauges[del_pb]
                    #for cur_idx, value of $scope.cur_gauges
                    $scope.$apply(
                        $scope.num_gauges = cur_pb.length
                        if cur_pb.length or $scope.progress_iters
                            if $scope.progress_iters
                                $scope.progress_iters--
                            $timeout($scope.update_progress_bar, 1000)
                    )
        $scope.redirect_to_init = () ->
            window.location = "http://www.init.at"
            return false
        $scope.redirect_to_info = () ->
            window.location = "{% url 'main:info_page' %}"
            return false
        $scope.redirect_to_handbook = () ->
            window.location = "/cluster/doc/main.pdf"
            return false
        $scope.show_handbook_page = () ->
            window.open(
                "{% url 'dyndoc:doc_page' 'x' %}".slice(0, -1) + $scope.HANDBOOK_PAGE
                "cluster documenation"
                "height=400,width=400,menubar=no,status=no,location=no,titlebar=no,resizeable=yes,scrollbars=yes"
            )
            return false
        $scope.redirect_to_bgj_info = () ->
            if $scope.check_perm('background_job.show_background')
                window.location = "{% url 'user:background_job_info' %}"
            return false
        $scope.get_background_job_class = () ->
            if $scope.NUM_BACKGROUND_JOBS < 4
                return "btn btn-xs btn-warning"
            else
                return "btn btn-xs btn-danger"
        $scope.rebuild_config = (cache_mode) ->
            call_ajax
                url     : "{% url 'mon:create_config' %}"
                data    : {
                    "cache_mode" : cache_mode
                }
                title   : "create config"
                success : (xml) =>
                    if parse_xml_response(xml)
                        # make at least five iterations to catch slow startup of md-config-server
                        $scope.progress_iters = 5
                        $scope.update_progress_bar()
        $scope.show_time()
])

# bootstrap angular
angular.element(document).ready(() ->
    angular.bootstrap($("nav[id='icsw.menu_app']"), ["icsw.menu_app"])
)

{% endinlinecoffeescript %}

</script>

